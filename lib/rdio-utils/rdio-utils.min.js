//! rdioUtils 0.0.8
//! Built on 2013-11-27
//! https://github.com/rdio/jsapi-examples/tree/master/utils
//! Copyright 2013, Rdio, Inc.
//! Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php
!function(a){function b(a){var b=document.getElementsByTagName("body")[0],c=document.createElement("div");c.className="rdio-utils-dialog",c.innerHTML="<div>"+a+"</div><br><button>OK</button>";var d=c.getElementsByTagName("button")[0];rdioUtils._bind(d,"click",function(){b.removeChild(c)}),b.appendChild(c)}var c=!1;window.rdioUtils={startupChecks:function(){return a?(a.on("flashError",function(){b("The Rdio API requires Flash in this browser. Please install (or unblock) the Flash plug-in.")}),a.on("cookieError",function(){b("The Rdio API won't work while cookies are blocked. Please unblock cookies for rdio.com.")}),!0):(b("Unable to contact Rdio API. Please try again later."),!1)},addToTopOfQueue:function(b){var c=function(d,e,f){d.get("key")==b&&(a.player.queue.off("add",c),a.player.queue.move(f.index,0))};a.player.queue.on("add",c),a.player.queue.add(b)},collectionAlbums:function(a){return new this.CollectionTracker(a)},authWidget:function(b){var c=this;b.jquery&&(b=b[0]);var d=function(){b.innerHTML=a.currentUser.get("firstName")+" "+a.currentUser.get("lastName")};a.ready(function(){a.authenticated()?d():(b.innerHTML="<button>Sign In With Rdio</button>",c._bind(b,"click",function(){a.authenticate(function(a){a&&d()})}))})},albumWidget:function(a){return new this.AlbumWidget(a)},localQueue:function(a){return new this.LocalQueue(a)},_bind:function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},_unbind:function(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent("on"+b,c)},_stopEvent:function(a){a.preventDefault?(a.preventDefault(),a.stopPropagation()):(a.cancelBubble=!0,a.returnValue=!1)},_escape:function(a){return a+="",a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},_log:function(){c&&window.console&&console.log&&console.log.apply(console,arguments)},_error:function(){window.console&&console.error&&console.error.apply(console,arguments)},_assert:function(a,b){window.console&&(console.assert?console.assert(a,b):a&&console.error&&console.error("[rdioUtils] assert failed: "+b))}}}(window.__rdio),function(a,b){var c=function(c){var d=/mac/i.test(navigator.userAgent);!d&&c.ctrlKey||d&&c.metaKey||(b._stopEvent(c),a.router.navigate(c.currentTarget.href))};b.AlbumWidget=function(d){var e;if(this._element=document.createElement("div"),this._element.className="rdio-utils-album",this._broken=!1,d){d.key&&!/^(a|al)[0-9]/.test(d.key)&&(b._error("[rdioUtils] Bad key for album widget: "+d.key),this._broken=!0);var f=["url","icon","name","artist","artistUrl","key"];for(e=0;e<f.length;e++)d[f[e]]||(b._error("[rdioUtils] Missing "+f[e]+" for album widget",d),this._broken=!0)}else b._error("[rdioUtils] Album is required for album widget"),this._broken=!0;if(this._broken)return this._element.innerHTML='<div class="rdio-utils-album-cover"><div class="rdio-utils-album-icon"></div></div><div class="rdio-utils-album-title rdio-utils-truncated">Unknown Album</div><div class="rdio-utils-album-author rdio-utils-truncated">&nbsp;</div><div class="rdio-utils-album-size rdio-utils-truncated">&nbsp;</div>',void 0;var g='<div class="rdio-utils-album-cover"><a href="http://www.rdio.com'+b._escape(d.url)+'">'+'<div class="rdio-utils-album-icon" style="background-image: url('+b._escape(d.icon)+')"></div>'+'<div class="rdio-utils-album-hover-overlay">'+'<div class="rdio-utils-album-play-btn"></div>'+"</div>"+"</a>"+"</div>"+'<div class="rdio-utils-album-title rdio-utils-truncated"><a href="http://www.rdio.com'+b._escape(d.url)+'">'+b._escape(d.name)+"</a></div>"+'<div class="rdio-utils-album-author rdio-utils-truncated"><a href="http://www.rdio.com'+b._escape(d.artistUrl)+'">'+b._escape(d.artist)+"</a></div>";d.length&&(g+='<div class="rdio-utils-album-size rdio-utils-truncated">'+b._escape(d.length)+" songs</div>"),this._element.innerHTML=g;var h=this._element.getElementsByTagName("a");for(e=0;e<h.length;e++)b._bind(h[e],"click",c);var i=this._element.getElementsByClassName("rdio-utils-album-play-btn")[0];b._bind(i,"click",function(c){b._stopEvent(c),(c.altKey||c.metaKey)&&a.player.queue.addPlayingSource(),a.player.play({source:d.key})})},b.AlbumWidget.prototype={element:function(){return this._element},broken:function(){return this._broken},_openActionMenu:function(){}}}(window.__rdio,window.rdioUtils),function(a,b){b.CollectionTracker=function(c){var d=this;if(this._config={onLoadComplete:c.onLoadComplete,onAlbumsLoaded:c.onAlbumsLoaded,onError:c.onError,onAdded:c.onAdded,onRemoved:c.onRemoved},c.localStorage&&window.JSON)try{var e="__rdioUtilsTestKey";localStorage.setItem(e,e),localStorage.removeItem(e),this._config.localStorage=!0}catch(f){}this.length=0,this._start=0,this._loading=null,this._albums=[],this._albumsByKey={},this._newAlbums=[],this._newAlbumsByKey={},this._firstTime=!0,this._bigExtras="-*,releaseDate,duration,isClean,canStream,icon,canSample,name,isExplicit,artist,url,length,trackKeys,artistUrl";var g=function(){if(d._config.localStorage){var c=localStorage.__rdioUtilsCollectionAlbums;if(c){var e=JSON.parse(c);if(e instanceof Array&&e.length){for(var f,g=0;g<e.length;g++)f=e[g],d._albumsByKey[f.key]=f;d._albums=e,d.length=d._albums.length,d._firstTime=!1,d._config.onAlbumsLoaded&&d._config.onAlbumsLoaded(e),d._config.onLoadComplete&&d._config.onLoadComplete();var h=localStorage.__rdioUtilsCollectionVersion;h!=a.currentUser.get("libraryVersion")&&d._startLoad()}}}d._firstTime&&d._startLoad(),a.currentUser.on("change:libraryVersion",function(a){b._log("change:libraryVersion: "+a),d._loading?(d._loading.loadAgain=!0,d._firstTime||(b._assert(d._loading.request,"_loading.request must exist"),d._loading.request.abort())):d._startLoad()})};a.ready(function(){if(a.authenticated())g();else{var b=function(c){c&&(a.off("change:authenticated",b),g())};a.on("change:authenticated",b)}})},b.CollectionTracker.prototype={at:function(a){return this._albums[a]},each:function(a){for(var b=0;b<this._albums.length;b++)a(this._albums[b],b)},_startLoad:function(){b._log("_startLoad"),this._start=0,this._newAlbums=[],this._newAlbumsByKey={},this._loading={},this._firstTime?(this._count=100,this._extras=this._bigExtras+",albumKey,rawArtistKey"):(this._count=1e3,this._extras="-*,albumKey"),this._load()},_load:function(){b._log("_load");var c=this;b._assert(this._loading,"_loading must exist"),b._assert(!this._loading.request,"_loading.request must not exist"),this._loading.request=a.request({method:"getAlbumsInCollection",content:{user:a.currentUser.get("key"),start:this._start,count:this._count,extras:this._extras,sort:"playCount"},success:function(a){if(c._loading.request=null,a.result.length){for(var b,d=0;d<a.result.length;d++)b=a.result[d],b.key=b.albumKey,delete b.albumKey,b.artistKey=b.rawArtistKey,delete b.rawArtistKey,c._newAlbums.push(b),c._newAlbumsByKey[b.key]=b;c._firstTime&&c._config.onAlbumsLoaded&&c._config.onAlbumsLoaded(a.result)}if(a.result.length==c._count)c._start+=c._count,c._load();else{var e=[],f=[];if(c._firstTime)c._albums=c._newAlbums,c._albumsByKey=c._newAlbumsByKey;else{var g;for(g in c._newAlbumsByKey)c._albumsByKey[g]||e.push(g);for(g in c._albumsByKey)c._newAlbumsByKey[g]||f.push(g);if(e.length)return c._getAlbums(e,function(a){c._finishLoad(a,f)}),void 0}c._finishLoad([],f)}},error:function(a){b._log("_load error: "+a.status),c._loading.request=null,"abort"!=a.status&&c._config.onError&&c._config.onError(a.message),c._loadingDone()}})},_getAlbums:function(c,d){b._log("_getAlbums");var e=this;b._assert(this._loading,"_loading must exist"),b._assert(!this._loading.request,"_loading.request must not exist");var f=200,g=c.slice(0,f),h=c.slice(f);this._loading.request=a.request({method:"get",content:{keys:g.join(","),extras:this._bigExtras+",key,artistKey"},success:function(a){e._loading.request=null;var b,c=[];for(var f in a.result)b=a.result[f],c.push(b);h.length?e._getAlbums(h,function(a){d(c.concat(a))}):d(c)},error:function(a){b._log("_getAlbums error: "+a.status),e._loading.request=null,"abort"!=a.status&&e._config.onError&&e._config.onError(a.message),e._loadingDone()}})},_finishLoad:function(a,b){var c,d,e=[];for(c=0;c<b.length;c++){d=b[c],e.push(this._albumsByKey[d]),delete this._albumsByKey[d];for(var f=0;f<this._albums.length;f++)if(this._albums[f].key==d){this._albums.splice(f,1);break}}var g;for(c=0;c<a.length;c++)g=a[c],this._albums.push(g),this._albumsByKey[g.key]=g;var h=this._firstTime;this._newAlbums=[],this._newAlbumsByKey={},this.length=this._albums.length,this._firstTime=!1,this._save(),h&&this._config.onLoadComplete&&this._config.onLoadComplete(),a.length&&this._config.onAdded&&this._config.onAdded(a),e.length&&this._config.onRemoved&&this._config.onRemoved(e),this._loadingDone()},_loadingDone:function(){b._assert(this._loading,"_loading must exist"),b._assert(!this._loading.request,"_loading.request must not exist");var a=this._loading.loadAgain;this._loading=null,a&&this._startLoad()},_save:function(){if(this._config.localStorage){var b=JSON.stringify(this._albums);localStorage.__rdioUtilsCollectionAlbums=b,localStorage.__rdioUtilsCollectionVersion=a.currentUser.get("libraryVersion")}}}}(window.__rdio,window.rdioUtils),function(a,b){b.LocalQueue=function(b){var c=this;this.length=0,this._onStart=b.onStart,this._onStop=b.onStop,this._onPlay=b.onPlay,this._onAdd=b.onAdd,this._onRemove=b.onRemove,this._sources=[],this._playing=!1,this._playingSource=null,this._keyFromQueue="",a.ready(function(){a.player.queue.on("remove",function(a,b,d){0===d.index&&(c._keyFromQueue=a.get("key"))}),a.player.on("change:playingSource",function(a){c._playing&&(c._playingSourceIsPlaying()||(a&&a.get("key")!=c._keyFromQueue||!c._sources.length?(c._playing=!1,c._playingSource=null,c._onStop&&c._onStop()):c._play(c.remove())))}),a.player.on("change:isMaster",function(a){c._playing&&!a&&(c._playing=!1,c._onStop&&c._onStop())})})},b.LocalQueue.prototype={stop:function(){this._playing&&(this._playingSourceIsPlaying()&&a.player.nextSource(),this._playing=!1,this._playingSource=null,this._onStop&&this._onStop())},add:function(a,b){var c={key:a};"undefined"==typeof b||0>b||b>=this._sources.length?(b=this._sources.length,this._sources.push(c)):this._sources.splice(b,0,c),this.length=this._sources.length,this._onAdd&&this._onAdd(c,b)},remove:function(a){var b=-1;if("undefined"==typeof a)this._sources.length&&(b=0);else if("number"==typeof a)a>=0&&a<this._sources.length&&(b=a);else for(var c=0;c<this._sources.length;c++)if(this._sources[c]===a){b=c;break}if(-1===b)return null;var d=this._sources.splice(b,1)[0];return this.length=this._sources.length,this._onRemove&&this._onRemove(d,b),d},play:function(a){var b,c=this;if("undefined"==typeof a){if(this._playing)return;if(b=this._playingSource||this.remove(),!b)return;this._play(b)}else{if(b=this.remove(a),!b)return;this._forceReady(function(){c._playingSourceIsPlaying()?c._play(b,{replace:!0}):c._play(b)})}},next:function(){this.play(0)},playing:function(){return this._playing},at:function(a){return this._sources[a]},each:function(a){for(var b=0;b<this._sources.length;b++)a(this._sources[b],b)},clear:function(){for(;this._sources.length;)this.remove()},_playingSourceIsPlaying:function(){var b=a.player.playingSource();return this._playingSource&&b&&b.get("key")==this._playingSource.key},_play:function(b,c){var d=this;c=c||{},this._forceMaster(function(){var e=b!=d._playingSource;d._playingSource=b,d._playingSourceIsPlaying()?a.player.play():(c.replace||a.player.queue.addPlayingSource(),a.player.play({source:d._playingSource.key}));var f=!d._playing;d._playing=!0,f&&d._onStart&&d._onStart(),e&&d._onPlay&&d._onPlay(d._playingSource)})},_forceMaster:function(b){this._forceReady(function(){if(a.player.isMaster())b();else{var c=function(d){d&&(a.player.off("change:isMaster",c),b())};a.player.on("change:isMaster",c),a.player.startMasterTakeover()}})},_forceReady:function(b){a.ready()?b():a.ready(b)}}}(window.__rdio,window.rdioUtils);